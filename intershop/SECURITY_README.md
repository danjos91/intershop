# Spring Security Implementation for Intershop

## Overview
This project now includes Spring Security for user authentication and authorization. The implementation uses the reactive stack (WebFlux) and integrates with your existing H2 database and Redis setup.

## Features Implemented

### 1. **User Authentication**
- Form-based login using Spring Security's default form
- Password encryption using BCrypt (industry standard)
- User data stored in H2 database
- Session management with automatic cleanup

### 2. **Access Control**
- **Public Routes**: `/`, `/items/**`, `/images/**`, `/css/**`, `/js/**`, `/login`
- **Protected Routes**: `/cart/**`, `/orders/**` (require authentication)
- **Default**: All other routes require authentication

### 3. **Security Configuration**
- CSRF protection disabled (for simplicity)
- Automatic session invalidation on logout
- Cookie cleanup on logout
- BCrypt password encoder configured

## How to Use

### 1. **Start the Application**
```bash
mvn spring-boot:run
```

### 2. **Create a Test User**
You have several options:

#### Option A: Use the SQL Script
Run the provided `create-test-user.sql` in your H2 console:
- Username: `testuser`
- Password: `testpass`

#### Option B: Create Programmatically
Use your application's API or database tools to create users. Passwords will be automatically encoded.

### 3. **Test Authentication**
1. Navigate to `/cart` or `/orders` - you'll be redirected to `/login`
2. Login with your credentials
3. You'll be redirected to the originally requested page
4. Use `/logout` to sign out

## Database Schema
Your existing `users` table is perfect for this implementation:
```sql
CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,  -- Stores BCrypt hashed passwords
    email VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Security Features

### **Password Security**
- All passwords are hashed using BCrypt
- Salt is automatically generated for each password
- Cost factor of 10 provides good security/performance balance

### **Session Management**
- HTTP sessions are automatically created on login
- Sessions are invalidated on logout
- Cookies are cleaned up on logout
- No persistent sessions between browser restarts

### **Route Protection**
- Cart and order operations require authentication
- Item browsing remains public
- Login page is accessible to everyone

## Files Added/Modified

### **New Files:**
- `SecurityConfig.java` - Main security configuration
- `CustomUserDetailsService.java` - User authentication service
- `AuthController.java` - Login/logout controller
- `login.html` - Login form template
- `create-test-user.sql` - Test user creation script
- `SECURITY_README.md` - This documentation

### **Modified Files:**
- `pom.xml` - Added Spring Security dependencies
- `UserService.java` - Added password encoding methods

## Testing

### **Test User Credentials:**
- Username: `testuser`
- Password: `testpass`

### **Test Scenarios:**
1. **Public Access**: Visit `/` and `/items` - should work without login
2. **Protected Access**: Visit `/cart` - should redirect to login
3. **Authentication**: Login with valid credentials
4. **Authorized Access**: After login, `/cart` should be accessible
5. **Logout**: Use `/logout` to sign out and verify session cleanup

## Next Steps (Optional Enhancements)

1. **Role-Based Access**: Add different user roles (ADMIN, USER, etc.)
2. **Password Reset**: Implement password reset functionality
3. **Remember Me**: Add "remember me" functionality
4. **OAuth2**: Integrate with external authentication providers
5. **Audit Logging**: Track user actions and security events

## Troubleshooting

### **Common Issues:**

1. **Login Not Working**: Check if user exists in database and password is properly encoded
2. **Redirect Loop**: Ensure login page is in the permitted paths
3. **Session Issues**: Check Redis configuration if using Redis for session storage

### **Debug Mode:**
Add to `application.yaml`:
```yaml
logging:
  level:
    org.springframework.security: DEBUG
```

## Security Best Practices Implemented

✅ Password hashing with BCrypt  
✅ Session invalidation on logout  
✅ Cookie cleanup on logout  
✅ Route-based access control  
✅ Secure password storage  
✅ No plain text passwords in database  

The implementation follows Spring Security best practices and provides a solid foundation for production use.
